# version: '3.9'

services:
  # Development PostgreSQL
  # No profile tag means this always runs by default
  postgres:
    image: postgres:18-trixie
    container_name: backend_postgres_dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data_dev:/var/lib/postgresql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend_network

  # Test PostgreSQL
  # Only starts when --profile test is used
  postgres_test:
    profiles: ["test"]
    image: postgres:18-trixie
    container_name: backend_postgres_test
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: test_db
    # Note: No volume mount for test database
    # Test data is ephemeral - when container stops, data is lost
    # This ensures tests always start with a clean slate
    ports:
      - "5433:5432"  # Different host port to avoid conflicts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d test_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test_network

  # Development Redis
  redis:
    image: redis:8-bookworm
    container_name: backend_redis_dev
    ports:
      - "6379:6379"
    volumes:
      - redis_data_dev:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend_network

  # Test Redis
  redis_test:
    profiles: ["test"]
    image: redis:8-bookworm
    container_name: backend_redis_test
    ports:
      - "6380:6379"  # Different host port
    # No volume - ephemeral test data
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - test_network

  # Development backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend_api_dev
    env_file:
      # Load infrastructure config first, then application config
      # This allows backend/.env to override if needed
      - ./.env
      - ./backend/.env
    volumes:
      # Mount only source directories for hot reload
      # This preserves .venv from the Docker build
      - ./backend/app:/app/app
      - ./backend/alembic:/app/alembic
      - ./backend/tests:/app/tests
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - backend_network
    restart: unless-stopped

  # Test backend
  backend_test:
    profiles: ["test"]
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: backend_api_test
    environment:
      # Override environment variables for test
      DATABASE_URL: postgresql+asyncpg://test_user:test_password@postgres_test:5432/test_db
      REDIS_URL: redis://redis_test:6379/0
      SECRET_KEY: test-secret-key-not-for-production
      TESTING: "true"
    volumes:
      - ./backend:/app
      - ./backend/alembic:/app/alembic
      - ./backend/tests:/app/tests
    depends_on:
      postgres_test:
        condition: service_healthy
      redis_test:
        condition: service_healthy
    networks:
      - test_network
    # Run tests and exit
    command: ["uv", "run", "pytest", "-v"]

volumes:
  postgres_data_dev:
    driver: local
  redis_data_dev:
    driver: local
  # Note: No volumes for test databases
  # Test data should be ephemeral

networks:
  backend_network:
    driver: bridge
  test_network:
    driver: bridge